<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map_4265273cde0c19b28c0ad82b533a6702 {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
</head>
<body>
    
    <script>
var unit = 'm';  // 'm' 或 'cm'
var totalDistance = 0;
var markers = [];
var lines = [];

function toRad(x) { return x * Math.PI / 180; }

function calcDistance(p1, p2) {
    var R = 6371000; // 地球半徑
    var lat1 = p1.lat;
    var lon1 = p1.lng;
    var lat2 = p2.lat;
    var lon2 = p2.lng;
    var dLat = toRad(lat2-lat1);
    var dLon = toRad(lon2-lon1);
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
            Math.sin(dLon/2)*Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    var d = R * c;
    return d;
}

function updateDistanceLabel(d) {
    var value = unit === 'm' ? (d/1).toFixed(2) + ' m' : (d*100).toFixed(1) + ' cm';
    return value;
}

function addMarker(e) {
    var newLatLng = e.latlng;
    var marker = L.marker(newLatLng).addTo(map);
    markers.push(marker);

    if (markers.length > 1) {
        var last = markers[markers.length-2];
        var dist = calcDistance(last.getLatLng(), newLatLng);
        totalDistance += dist;
        var midLat = (last.getLatLng().lat + newLatLng.lat)/2;
        var midLng = (last.getLatLng().lng + newLatLng.lng)/2;

        var line = L.polyline([last.getLatLng(), newLatLng],
                              {color: dist < 50 ? 'green' : 'orange', weight: 3}).addTo(map);
        lines.push(line);

        L.marker([midLat, midLng], {
            icon: L.divIcon({className:'distance-label', html:'<div style="color:red;font-size:12px;">'+updateDistanceLabel(dist)+'</div>'})
        }).addTo(map);
    }

    updateTotalDistance();
}

function deleteLastMarker() {
    if (markers.length === 0) return;
    var last = markers.pop();
    map.removeLayer(last);
    if (lines.length > 0) {
        var line = lines.pop();
        map.removeLayer(line);
    }
    // 重新計算 totalDistance
    totalDistance = 0;
    for (var i=1; i<markers.length; i++) {
        totalDistance += calcDistance(markers[i-1].getLatLng(), markers[i].getLatLng());
    }
    updateTotalDistance();
}

function toggleUnit() {
    unit = unit === 'm' ? 'cm' : 'm';
    updateTotalDistance();
}

function updateTotalDistance() {
    var label = document.getElementById('totalDistance');
    if (!label) {
        label = L.control({position: 'topright'});
        label.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'distance-total');
            div.id = 'totalDistance';
            div.style.backgroundColor = 'white';
            div.style.padding = '5px';
            div.style.fontSize = '14px';
            div.style.fontWeight = 'bold';
            div.style.border = '1px solid gray';
            return div;
        }
        label.addTo(map);
    }
    document.getElementById('totalDistance').innerHTML = '累積距離: ' + updateDistanceLabel(totalDistance);
}

// ----------------- 按鈕
var btnDiv = L.control({position: 'topleft'});
btnDiv.onAdd = function(map) {
    var div = L.DomUtil.create('div', 'btn-div');
    div.innerHTML = '<button onclick="deleteLastMarker()" style="margin:2px;">刪除最後一點</button>' +
                    '<button onclick="toggleUnit()" style="margin:2px;">切換單位</button>';
    return div;
}
btnDiv.addTo(map);

map.on('click', addMarker);
updateTotalDistance();
</script>
    
            <div class="folium-map" id="map_4265273cde0c19b28c0ad82b533a6702" ></div>
        
</body>
<script>
    
    
            var map_4265273cde0c19b28c0ad82b533a6702 = L.map(
                "map_4265273cde0c19b28c0ad82b533a6702",
                {
                    center: [25.033, 121.5654],
                    crs: L.CRS.EPSG3857,
                    ...{
  "zoom": 17,
  "zoomControl": true,
  "preferCanvas": false,
}

                }
            );

            

        
    
            var tile_layer_7bf666a7fdba11a5255b2a332d2d11e0 = L.tileLayer(
                "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
  "minZoom": 0,
  "maxZoom": 19,
  "maxNativeZoom": 19,
  "noWrap": false,
  "attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors",
  "subdomains": "abc",
  "detectRetina": false,
  "tms": false,
  "opacity": 1,
}

            );
        
    
            tile_layer_7bf666a7fdba11a5255b2a332d2d11e0.addTo(map_4265273cde0c19b28c0ad82b533a6702);
        
    
            var circle_marker_9b0e28142d3030b407135919ac31efc9 = L.circleMarker(
                [25.033, 121.5654],
                {"bubblingMouseEvents": true, "color": "blue", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "blue", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(map_4265273cde0c19b28c0ad82b533a6702);
        
    
        var popup_4d2510fff061ec6da430488329ba2386 = L.popup({
  "maxWidth": "100%",
});

        
            
                var html_d7a53b3ff79f32a5f11e0b0e44fb55cf = $(`<div id="html_d7a53b3ff79f32a5f11e0b0e44fb55cf" style="width: 100.0%; height: 100.0%;">點 1</div>`)[0];
                popup_4d2510fff061ec6da430488329ba2386.setContent(html_d7a53b3ff79f32a5f11e0b0e44fb55cf);
            
        

        circle_marker_9b0e28142d3030b407135919ac31efc9.bindPopup(popup_4d2510fff061ec6da430488329ba2386)
        ;

        
    
    
            var circle_marker_a51f16b82cfc8433715067ee90bdd555 = L.circleMarker(
                [25.033, 121.5655],
                {"bubblingMouseEvents": true, "color": "blue", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "blue", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(map_4265273cde0c19b28c0ad82b533a6702);
        
    
        var popup_0f2675cea563d345428cf73e5fd8c21a = L.popup({
  "maxWidth": "100%",
});

        
            
                var html_bc625858531b51e0d3c8fb7f22c0f50d = $(`<div id="html_bc625858531b51e0d3c8fb7f22c0f50d" style="width: 100.0%; height: 100.0%;">點 2</div>`)[0];
                popup_0f2675cea563d345428cf73e5fd8c21a.setContent(html_bc625858531b51e0d3c8fb7f22c0f50d);
            
        

        circle_marker_a51f16b82cfc8433715067ee90bdd555.bindPopup(popup_0f2675cea563d345428cf73e5fd8c21a)
        ;

        
    
    
            var marker_22c779757aa7e0d8f6a16fe1d338998d = L.marker(
                [25.033, 121.56545],
                {
}
            ).addTo(map_4265273cde0c19b28c0ad82b533a6702);
        
    
            var div_icon_6509a994f669c50022031e9801ded8bd = L.divIcon({
  "html": "\u003cdiv style=\"font-size:12px;color:red;\"\u003e10.09 m\u003c/div\u003e",
  "className": "empty",
});
        
    
                marker_22c779757aa7e0d8f6a16fe1d338998d.setIcon(div_icon_6509a994f669c50022031e9801ded8bd);
            
    
            var poly_line_a80c40ccc5b7ff095704764190a38dd7 = L.polyline(
                [[25.033, 121.5654], [25.033, 121.5655]],
                {"bubblingMouseEvents": true, "color": "green", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "green", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 3}
            ).addTo(map_4265273cde0c19b28c0ad82b533a6702);
        
</script>
</html>